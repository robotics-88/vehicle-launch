<launch>

                            <!-- Arguments/configuration -->
    <arg name="mavros_map_frame" default="map"/>

    <!-- Safe guards -->
    <arg name="enable_autonomy" default="false"/>
    <arg name="use_failsafes" default="false"/> <!-- Set to TRUE once failsafes are working better-->

    <!-- Which nodes -->
    <arg name="do_mavros" default="true"/>
    <arg name="do_task_manager" default="true"/>
    <arg name="do_rtsp" default="true"/>
    <arg name="do_record" default="true"/>
    
    <!-- Which hardware -->
    <arg name="do_see3cam_down" default="true"/>
    <arg name="do_see3cam_fwd" default="false"/>
    <arg name="do_thermal_cam" default="true"/>

    <arg name="thermal_topic" default="/seek_thermal/image"/>
    <arg name="thermal_info_topic" default="/seek_thermal/camera_info"/>

     <!-- Recording args -->
    <arg name="record_config_file" default="$(find-pkg-share vehicle_launch)/config/r88_default.config"/>
    <arg name="user" default="$(env USER)"/>
    <arg name="data_directory" default="/home/$(var user)/src/bags/"/>

    <!-- Control args -->
    <arg name="px4" default="true"/>

    <!-- Generic args -->
    <arg name="map_resolution" default="0.1"/> <!-- meter -->
    <arg name="goal_topic" default="/goal_raw"/> <!-- meter -->

                                <!-- ROS nodes -->

    <!-- MAVROS -->
    <group if="$(var do_mavros)">
        <include file="$(find-pkg-share vehicle_launch)/launch/px4.launch" if="$(var px4)">
            <arg name="fcu_url" value="udp://127.0.0.1:14575@"/>
        </include>
        <include file="$(find-pkg-share vehicle_launch)/launch/apm.launch" unless="$(var px4)">
            <arg name="do_slam" value="false"/>
            <arg name="fcu_url" value="udp://127.0.0.1:14575@"/>
        </include>
    </group>

    <include file="$(find-pkg-share bag_recorder_2)/launch/bag_recorder.launch" if="$(var do_record)"/>

    <!--                                 Hardware                            -->
    <group>
        <push-ros-namespace namespace="downward_rgb"/>
        <include file="$(find-pkg-share vehicle_launch)/launch/sensors/see3cam.launch" if="$(var do_see3cam_down)"/>
    </group>
    <group>
        <push-ros-namespace namespace="forward_rgb"/>
        <include file="$(find-pkg-share vehicle_launch)/launch/sensors/see3cam.launch" if="$(var do_see3cam_fwd)"/>
    </group>

    <!--                        RTSP Streams for each camera                 -->
    <group if="$(var do_rtsp)">
        <node name="rtsp_stream_mapir" pkg="image_to_v4l2loopback" exec="stream">
            <param name="device" value="/dev/video21"/>
            <param name="width" value="640"/>
            <param name="height" value="480"/>
            <param name="fourcc" value="YV12"/>
            <remap from="image" to="/downward_rgb/see3cam/image_raw"/>
        </node>

        <node name="rtsp_stream_thermal" pkg="image_to_v4l2loopback" exec="stream" if="$(var do_thermal_cam)">
            <param name="device" value="/dev/video22"/>
            <param name="width" value="320"/>
            <param name="height" value="240"/>
            <param name="fourcc" value="YV12"/>
            <remap from="image" to="$(var thermal_topic)"/>
        </node>
    </group>

    <include file="$(find-pkg-share vehicle_launch)/launch/static_tf.launch">
        <arg name="do_thermal_cam" value="$(var do_thermal_cam)"/>
    </include>

    <!-- Thermal Camera & Processing Pipeline -->
    <group if="$(var do_thermal_cam)">
        <include file="$(find-pkg-share thermal_88)/launch/thermal_pipeline.launch" if="$(var do_thermal_cam)">
            <arg name="image_topic" value="$(var thermal_topic)"/>
            <arg name="camera_info_topic" value="$(var thermal_info_topic)"/>
            <arg name="map_frame" value="$(var mavros_map_frame)"/>
            <arg name="use_rviz" value="false"/>
        </include>
        
        <include file="$(find-pkg-share vehicle_launch)/launch/sensors/seek_cam.launch"/>
    </group>

    <!-- Task Manager (Main Control Loop) -->
    <include file="$(find-pkg-share task_manager)/launch/task_manager.launch" if="$(var do_task_manager)">
        <arg name="do_slam" value="false"/>
        <arg name="do_record" value="$(var do_record)"/>
        <arg name="record_config_file" value="$(var record_config_file)"/>
        <arg name="data_directory" value="$(var data_directory)"/>
        <arg name="do_downward_rgb" value="$(var do_see3cam_down)"/>
        <arg name="do_attollo" value="$(var do_attollo)"/>
        <arg name="do_thermal_cam" value="$(var do_thermal_cam)"/>
        <arg name="px4" value="$(var px4)"/>

        <arg name="estimated_current" value="20.0"/> 
        <arg name="battery_size" value="5.21"/> 
        <arg name="all_stream_rate" value="5.0"/>
        <arg name="imu_rate" value="50.0"/>
        <arg name="local_pos_rate" value="30.0"/>
    </include>

</launch>
